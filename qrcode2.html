<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Météo 72h – Swipe</title>

<style>
    body {
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
        background: #eef3f7;
        overflow: hidden; /* empêche tout scroll */
    }

    h1 {
        margin: 8px 0 0 0;
        text-align: center;
        font-size: 18px;
    }

    #swipe-hint {
        text-align: center;
        font-size: 11px;
        opacity: 0.6;
        margin-bottom: 5px;
    }

    .carousel {
        display: flex;
        width: 200vw; /* 2 pages */
        transition: transform 0.3s ease;
    }

    .page {
        width: 100vw;
        height: calc(100vh - 70px); /* tient sous le header */
        overflow: hidden;
        padding: 4px;
        box-sizing: border-box;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        font-size: 11px;
    }

    th, td {
        border-bottom: 1px solid #cdd4db;
        padding: 2px 3px;
        text-align: center;
        white-space: nowrap;
    }

    th {
        background: #d7e3ee;
        font-size: 10px;
    }

    .units { font-size: 9px; opacity: 0.6; }

    #pagination {
        text-align: center;
        margin-top: 4px;
    }

    .dot {
        height: 8px;
        width: 8px;
        margin: 0 4px;
        background: #a0a9b2;
        border-radius: 50%;
        display: inline-block;
    }

    .active {
        background: #1976d2;
    }
</style>
</head>

<body>

<h1>Prévisions météo</h1>
<div id="swipe-hint">◀︎ glisser ▶︎</div>

<div id="carousel-container" style="overflow:hidden;">
    <div id="carousel" class="carousel">
        <div class="page"><table><thead id="thead1"></thead><tbody id="tbody1"></tbody></table></div>
        <div class="page"><table><thead id="thead2"></thead><tbody id="tbody2"></tbody></table></div>
    </div>
</div>

<div id="pagination">
    <span class="dot active" id="p1"></span>
    <span class="dot" id="p2"></span>
</div>

<script>
// -------------------------------
// CONFIG : position (GPS bientôt possible)
// -------------------------------
let latitude = 48.8566;
let longitude = 2.3522;

// -------------------------------
// UTILITAIRES
// -------------------------------
function directionVent(angle) {
    const dirs = ["N","NE","E","SE","S","SO","O","NO"];
    return dirs[Math.round(angle / 45) % 8];
}

function formatTime(dateStr) {
    let d = new Date(dateStr);
    return d.toLocaleTimeString("fr-FR",{hour:"2-digit", minute:"2-digit"});
}

function jourCourt(dateStr) {
    let d = new Date(dateStr);
    return d.toLocaleDateString("fr-FR", { weekday: "short" });
}

// Trouver slot de 3h courant
function arrondirVersTranche3h(d) {
    let h = d.getHours();
    return h - (h % 3);
}

// -------------------------------
// CHARGER METEO
// -------------------------------
async function chargerMeteo() {
    const now = new Date();
    const startHour = arrondirVersTranche3h(now);

    const url = `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}`
      + `&hourly=temperature_2m,precipitation,wind_speed_10m,wind_gusts_10m,wind_direction_10m`
      + `&daily=sunrise,sunset`
      + `&forecast_days=3&timezone=auto`;

    const res = await fetch(url);
    const data = await res.json();

    const h = data.hourly.time;
    const T = data.hourly.temperature_2m;
    const P = data.hourly.precipitation;
    const V = data.hourly.wind_speed_10m;
    const G = data.hourly.wind_gusts_10m;
    const D = data.hourly.wind_direction_10m;

    // Soleil par jour
    const sunrise = data.daily.sunrise;
    const sunset = data.daily.sunset;

    // -------------------------------
    // GENERATION DES PAGES (36h chacune)
    // -------------------------------
    const theads = [document.getElementById("thead1"), document.getElementById("thead2")];
    const tbodys = [document.getElementById("tbody1"), document.getElementById("tbody2")];

    // En-têtes identiques
    const header = `
        <tr>
            <th>J</th>
            <th>Soleil</th>
            <th>Hr</th>
            <th>T.<span class="units">°C</span></th>
            <th>Pl.<span class="units">mm</span></th>
            <th>Vent</th>
            <th>Raf.</th>
            <th>Dir.</th>
        </tr>`;
    theads[0].innerHTML = header;
    theads[1].innerHTML = header;

    // Trouver l’index du premier slot
    let idx = h.findIndex(t => {
        let d = new Date(t);
        return d.getHours() === startHour &&
               d.getDate() === now.getDate();
    });

    if (idx < 0) idx = 0; // fallback

    // 72h = 24 slots; nous affichons seulement 12 par page
    const slotsParPage = 12;

    for (let page = 0; page < 2; page++) {
        let tbody = tbodys[page];
        tbody.innerHTML = "";

        for (let i = 0; i < slotsParPage; i++) {
            let k = idx + page * slotsParPage + i;
            if (k >= h.length) continue;

            let date = new Date(h[k]);
            let jour = jourCourt(h[k]);
            let hr = formatTime(h[k]).slice(0,5);

            // Soleil pour ce jour
            let jIndex = data.daily.time.indexOf(h[k].slice(0,10));
            let sol = (jIndex >= 0)
                ? formatTime(sunrise[jIndex]).slice(0,5) + "/" + formatTime(sunset[jIndex]).slice(0,5)
                : "--/--";

            // Ajout ligne
            tbody.insertAdjacentHTML("beforeend", `
                <tr>
                    <td>${jour}</td>
                    <td>${sol}</td>
                    <td>${hr}</td>
                    <td>${Math.round(T[k])}</td>
                    <td>${P[k].toFixed(1)}</td>
                    <td>${Math.round(V[k])}</td>
                    <td>${Math.round(G[k])}</td>
                    <td>${directionVent(D[k])}</td>
                </tr>
            `);
        }
    }
}

// -------------------------------
// CAROUSEL (SWIPE)
// -------------------------------
let currentPage = 0;
let startX = 0;
const carousel = document.getElementById("carousel");

function setPage(p) {
    currentPage = p;
    carousel.style.transform = `translateX(-${p * 100}vw)`;
    document.getElementById("p1").classList.toggle("active", p === 0);
    document.getElementById("p2").classList.toggle("active", p === 1);
}

document.addEventListener("touchstart", e => {
    startX = e.touches[0].clientX;
});

document.addEventListener("touchend", e => {
    let endX = e.changedTouches[0].clientX;
    let diff = startX - endX;

    if (diff > 50 && currentPage === 0) setPage(1);
    else if (diff < -50 && currentPage === 1) setPage(0);
});

// -------------------------------
chargerMeteo();
</script>
</body>
</html>
