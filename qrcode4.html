<script>

/* --------------------------------------- */
/* API METEO : OPEN-METEO (sans clé)       */
/* --------------------------------------- */

async function loadWeather(city) {

    document.getElementById("home").style.display = "none";
    document.getElementById("main").style.display = "block";
    document.getElementById("meteoTitle").innerText = city;

    // GEO API
    const geoUrl = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(city)}&count=1&language=fr&format=json`;
    const geo = await fetch(geoUrl).then(r => r.json());

    if (!geo.results || !geo.results.length) {
        alert("Ville introuvable");
        return;
    }

    const { latitude, longitude } = geo.results[0];

    loadWeatherByCoords(latitude, longitude, city);
}


async function loadWeatherByCoords(lat, lon, label = "Ma position") {

    document.getElementById("home").style.display = "none";
    document.getElementById("main").style.display = "block";
    document.getElementById("meteoTitle").innerText = label;

    const url = `
        https://api.open-meteo.com/v1/forecast?
        latitude=${lat}&longitude=${lon}
        &hourly=temperature_2m,precipitation,wind_speed_10m,wind_gusts_10m,wind_direction_10m
        &daily=sunrise,sunset
        &timezone=auto
    `.replace(/\s+/g, '');

    const data = await fetch(url).then(r => r.json());

    buildWeatherTable(data);
}


/* --------------------------------------- */
/* TABLEAU METEO                           */
/* --------------------------------------- */

function buildWeatherTable(data) {

    const table = document.getElementById("meteoTable");
    table.innerHTML = `
        <tr>
            <th>Heure</th>
            <th>T°</th>
            <th>Pluie</th>
            <th>Vent</th>
            <th>Rafales</th>
        </tr>
    `;

    const usableHeight = document.getElementById("meteo").offsetHeight - 60;
    const rowHeight = 45;
    const maxRows = Math.floor(usableHeight / rowHeight);

    const slots = build4hSlots(data);
    const rows = slots.slice(0, maxRows);

    rows.forEach(r => {
        const tr = document.createElement("tr");

        tr.innerHTML = `
            <td>${r.hour}</td>
            <td>${Math.round(r.temp)}°</td>
            <td>${r.rain.toFixed(1)} mm</td>
            <td>${r.wind_dir} ${r.wind_speed} km/h</td>
            <td>${r.wind_gust} km/h</td>
        `;

        // gradient
        const intens = Math.min(r.wind_gust, 72) / 72;
        tr.children[4].style.background =
            `rgb(${255 - 255*intens}, ${255 - 255*intens}, ${255 - 255*intens})`;
        tr.children[4].style.color = intens > 0.5 ? "white" : "black";

        table.appendChild(tr);
    });
}


/* --------------------------------------- */
/* Construire les tranches de 4 heures     */
/* --------------------------------------- */

function build4hSlots(data) {

    const tranches = [0, 4, 8, 12, 16, 20];

    const hours = data.hourly.time;
    const temp = data.hourly.temperature_2m;
    const rain = data.hourly.precipitation;
    const wind = data.hourly.wind_speed_10m;
    const gust = data.hourly.wind_gusts_10m;
    const dir = data.hourly.wind_direction_10m;

    const now = new Date();
    const currentHour = now.getHours();
    const startTranche = tranches.reduce((acc, h) => currentHour >= h ? h : acc, 0);

    const slots = [];

    for (let h = 0; h < hours.length; h++) {

        const date = new Date(hours[h]);
        const hour = date.getHours();

        const tranche = tranches.reduce((acc, t) => hour >= t ? t : acc, 0);

        if (slots.length === 0 && tranche < startTranche) continue;
        if (slots.some(s => s.hour === formatHour(tranche))) continue;

        slots.push({
            hour: formatHour(tranche),
            temp: temp[h],
            rain: rain[h],
            wind_speed: Math.round(wind[h]),
            wind_gust: Math.round(gust[h]),
            wind_dir: degToArrow(dir[h])
        });

        if (slots.length >= 12) break;
    }

    return slots;
}

/* --------------------------------------- */
/* Outils                                   */
/* --------------------------------------- */

function formatHour(h) {
    return (h < 10 ? "0" : "") + h + "h";
}

function degToArrow(deg) {
    if (typeof deg !== "number" || isNaN(deg)) return "•";
    const dirs = ["↑","↗","→","↘","↓","↙","←","↖"];
    return dirs[Math.round(deg / 45) % 8];
}


/* --------------------------------------- */
/* Loader + Boutons                         */
/* --------------------------------------- */

setTimeout(() => {
    document.getElementById('loader').classList.add("fade-out");
    setTimeout(() => {
        document.getElementById('loader').style.display = "none";
        document.getElementById('home').style.display = "flex";
    }, 800);
}, 2600);

document.getElementById("btnValider").onclick = () => {
    const city = document.getElementById("cityInput").value.trim();
    if (!city) return alert("Entre une ville.");
    loadWeather(city);
};

document.getElementById("btnGPS").onclick = () => {
    navigator.geolocation.getCurrentPosition(pos => {
        loadWeatherByCoords(pos.coords.latitude, pos.coords.longitude);
    });
};

document.getElementById("btnGrutier").onclick = () => {
    loadWeather("Paris");
    document.getElementById("main").scrollTo(0, window.innerHeight);
};

</script>
