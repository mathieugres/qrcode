<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Grutier – Prévisions</title>

<style>
body {
    margin: 0;
    background: #111;
    color: white;
    font-family: Arial, sans-serif;
}

/* SECTIONS */
.section {
    height: 100vh;
    scroll-snap-align: start;
}

/* SCROLL MAGNÉTIQUE */
#main {
    height: 100vh;
    overflow-y: scroll;
    scroll-snap-type: y mandatory;
}

/* LOADER */
#loader {
    position: fixed;
    inset: 0;
    background: #111;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 30px;
    opacity: 1;
    transition: opacity 0.8s;
}
.fade-out { opacity: 0; }

/* ÉCRAN ACCUEIL */
#home {
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 15px;
    height: 100vh;
}

input {
    width: 250px;
    padding: 10px;
    border-radius: 5px;
    border: none;
    font-size: 16px;
}

button {
    padding: 10px 20px;
    border-radius: 6px;
    border: none;
    background: #333;
    color: white;
    font-size: 16px;
}

/* METEO */
#meteoTitle {
    text-align: center;
    font-size: 22px;
    font-weight: bold;
    padding: 15px 0;
}

table {
    width: 100%;
    border-collapse: collapse;
    text-align: center;
}
th, td {
    padding: 8px 0;
    border-bottom: 1px solid #333;
}

</style>
</head>
<body>

<!-- LOADER -->
<div id="loader">Chargement…</div>

<!-- ACCUEIL -->
<div id="home">
    <input id="cityInput" placeholder="Entrez une ville…">
    <button id="btnValider">Valider la ville</button>
    <button id="btnGPS">GPS</button>
    <button id="btnGrutier">Grutier confirmé</button>
</div>

<!-- PAGE PRINCIPALE -->
<div id="main">

    <!-- PARTIE METEO -->
    <div id="meteo" class="section">
        <div id="meteoTitle">Ville</div>
        <table id="meteoTable"></table>
    </div>

    <!-- PARTIE FICHE -->
    <div id="fiche" class="section" style="padding:20px;">
        <h2>Fiche Grutier</h2>
        <p>Mathieu Grès – 09/10/89</p>
        <p>Expérience : 5 ans</p>
        <p>Chantiers : Dumez, Arbonis, Verdoïa, Angevin, Maître Cube, Constantini</p>
        <p>Taux horaire :<br>
            • Sol (télécommande) : 21€/h (25€/h déc–mars)<br>
            • Cabine : 19€/h
        </p>
        <a href="tel:0650980791">
            <button>Appeler</button>
        </a>
    </div>

</div>

<!-- SCRIPT METEO + LOADER -->
<script>
document.addEventListener("DOMContentLoaded", () => {

    // --- LOADER ---
    const loader = document.getElementById('loader');
    setTimeout(() => {
        loader.classList.add("fade-out");
        setTimeout(() => {
            loader.style.display = "none";
            document.getElementById('home').style.display = "flex";
        }, 800);
    }, 2200);

    // --- BOUTONS ---
    document.getElementById("btnValider").onclick = () => {
        const city = document.getElementById("cityInput").value.trim();
        if (!city) return alert("Entre une ville.");
        loadWeather(city);
    };

    document.getElementById("btnGPS").onclick = () =>
        navigator.geolocation.getCurrentPosition(pos =>
            loadWeatherByCoords(pos.coords.latitude, pos.coords.longitude)
        );

    document.getElementById("btnGrutier").onclick = () => {
        loadWeather("Paris");
        document.getElementById("main").scrollTo(0, window.innerHeight);
    };

    // --- FONCTIONS METEO ---
    async function loadWeather(city) {
        document.getElementById("home").style.display = "none";
        document.getElementById("main").style.display = "block";
        document.getElementById("meteoTitle").innerText = city;

        const geoUrl = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(city)}&count=1&language=fr&format=json`;
        const geo = await fetch(geoUrl).then(r => r.json());

        if (!geo.results || !geo.results.length) {
            alert("Ville introuvable");
            return;
        }

        const { latitude, longitude } = geo.results[0];
        loadWeatherByCoords(latitude, longitude, city);
    }

    async function loadWeatherByCoords(lat, lon, label="Ma position") {
        document.getElementById("home").style.display = "none";
        document.getElementById("main").style.display = "block";
        document.getElementById("meteoTitle").innerText = label;

        const url = `
            https://api.open-meteo.com/v1/forecast?
            latitude=${lat}&longitude=${lon}
            &hourly=temperature_2m,precipitation,wind_speed_10m,wind_gusts_10m,wind_direction_10m
            &timezone=auto
        `.replace(/\s+/g, '');

        const data = await fetch(url).then(r => r.json());
        buildWeatherTable(data);
    }

    function buildWeatherTable(data) {
        const table = document.getElementById("meteoTable");
        table.innerHTML = `
            <tr>
                <th>Heure</th>
                <th>T°</th>
                <th>Pluie</th>
                <th>Vent</th>
                <th>Rafales</th>
            </tr>
        `;

        const usableHeight = document.getElementById("meteo").offsetHeight - 60;
        const rowHeight = 45;
        const maxRows = Math.floor(usableHeight / rowHeight);

        const slots = build4hSlots(data).slice(0, maxRows);

        slots.forEach(r => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${r.hour}</td>
                <td>${Math.round(r.temp)}°</td>
                <td>${r.rain.toFixed(1)} mm</td>
                <td>${r.wind_dir} ${r.wind_speed} km/h</td>
                <td>${r.wind_gust} km/h</td>
            `;
            table.appendChild(tr);
        });
    }

    function build4hSlots(data) {
        const tranches = [0, 4, 8, 12, 16, 20];
        const hours = data.hourly.time;
        const temp = data.hourly.temperature_2m;
        const rain = data.hourly.precipitation;
        const wind = data.hourly.wind_speed_10m;
        const gust = data.hourly.wind_gusts_10m;
        const dir = data.hourly.wind_direction_10m;

        const now = new Date();
        const currentHour = now.getHours();
        const start = tranches.reduce((a,h)=>currentHour>=h?h:a,0);

        const slots = [];
        for (let h=0; h<hours.length; h++){
            const d = new Date(hours[h]);
            const hour = d.getHours();
            const tranche = tranches.reduce((a,t)=>hour>=t?t:a,0);

            if(slots.length===0 && tranche<start) continue;
            if(slots.some(s=>s.hour===formatHour(tranche))) continue;

            slots.push({
                hour: formatHour(tranche),
                temp: temp[h],
                rain: rain[h],
                wind_speed: Math.round(wind[h]),
                wind_gust: Math.round(gust[h]),
                wind_dir: degToArrow(dir[h])
            });

            if(slots.length>=12) break;
        }
        return slots;
    }

    function formatHour(h){ return (h<10?"0":"")+h+"h"; }
    function degToArrow(deg){
        if(!deg) return "•";
        const dirs=["↑","↗","→","↘","↓","↙","←","↖"];
        return dirs[Math.round(deg/45)%8];
    }

});
</script>

</body>
</html>
